# Step 1: Import libraries
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import r2_score, mean_squared_error
import matplotlib.pyplot as plt

# Step 2: Load dataset
df = pd.read_csv("uber.csv")
print("Initial data shape:", df.shape)

# Step 3: Data Preprocessing
# Remove missing values
df = df.dropna()

# Remove invalid fare or passenger count
df = df[(df['fare_amount'] > 0) & (df['fare_amount'] < 100)]
df = df[(df['passenger_count'] > 0) & (df['passenger_count'] < 8)]

# Step 4: Calculate distance using Haversine formula
def distance(lat1, lon1, lat2, lon2):
    lon1, lat1, lon2, lat2 = map(np.radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    a = np.sin(dlat/2)**2 + np.cos(lat1)*np.cos(lat2)*np.sin(dlon/2)**2
    c = 2 * np.arcsin(np.sqrt(a))
    r = 6371  # Earth's radius in km
    return c * r

df['distance_km'] = distance(df['pickup_latitude'], df['pickup_longitude'],
                             df['dropoff_latitude'], df['dropoff_longitude'])

# Remove zero distances
df = df[df['distance_km'] > 0]

# Step 5: Check correlation
print("\nCorrelation:\n", df[['fare_amount', 'distance_km', 'passenger_count']].corr())

# Step 6: Prepare data for training
X = df[['distance_km', 'passenger_count']]
y = df['fare_amount']

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Step 7: Train models
lr = LinearRegression()
lr.fit(X_train, y_train)
y_pred_lr = lr.predict(X_test)

rf = RandomForestRegressor(random_state=42)
rf.fit(X_train, y_train)
y_pred_rf = rf.predict(X_test)

# Step 8: Evaluate models
def evaluate(name, y_true, y_pred):
    r2 = r2_score(y_true, y_pred)
    rmse = np.sqrt(mean_squared_error(y_true, y_pred))
    print(f"{name} - R2: {r2:.3f}, RMSE: {rmse:.2f}")

evaluate("Linear Regression", y_test, y_pred_lr)
evaluate("Random Forest", y_test, y_pred_rf)

# Step 9: Compare visually
plt.bar(["Linear Regression", "Random Forest"],
        [r2_score(y_test, y_pred_lr), r2_score(y_test, y_pred_rf)],
        color=['skyblue', 'orange'])
plt.title("Model Comparison (R2 Score)")
plt.show()
